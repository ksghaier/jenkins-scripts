pipeline {
    agent any

    environment {
        SSH_KEY='/var/lib/jenkins/.ssh/nxp-automation'
    }

    options {
        disableConcurrentBuilds()
        quietPeriod 600
    }

    triggers{ pollSCM('H/15 * * * *') }

    stages {

        stage('build docker') {
            steps {
                sh '''docker build -t nxp-yocto --build-arg SSH_KEY=\"$(cat /var/lib/jenkins/.ssh/nxp-automation)\" yocto/nxp-docker -f Dockerfile-nxp-yocto-20.04'''
            }
        }

        stage('build yocto') {
            steps {
                dir("work") {
                    sh '''${WORKSPACE}/yocto/nxp-docker/docker-run-user.sh -n nxp-yocto -b $(pwd) ./build-yocto.sh -H 10.161.69.158:8686 -P 10.161.69.158:8585'''
                }
            }
        }
    }
}